function e(e){let t=e.clientWidth,n=e.clientHeight,r=e.width!==t||e.height!==n;return r&&(e.width=t,e.height=n),r}function t(e,t,n,r,i=-1,a=1){let o=1/(e-t),s=1/(n-r),c=1/(i-a);return new Float32Array([-2*o,0,0,0,0,-2*s,0,0,0,0,2*c,0,(e+t)*o,(r+n)*s,(a+i)*c,1])}function n(e){let t,n,r,i;if(typeof e==`string`){e=e.trim();let a=e.match(/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/);if(a){let e=a[1];t=parseInt(e.slice(0,2),16),n=parseInt(e.slice(2,4),16),r=parseInt(e.slice(4,6),16),i=e.length===8?parseInt(e.slice(6,8),16):255}else{let a=e.match(/^rgba?\(\s*([\d.]+%?)\s*,\s*([\d.]+%?)\s*,\s*([\d.]+%?)\s*(?:,\s*([\d.]+%?)\s*)?\)$/);if(!a)return console.error(`Color format not valid: "${e}"`),new Float32Array([1,1,1,1]);let o=e=>e.endsWith(`%`)?Math.round(parseFloat(e)/100*255):Math.round(parseFloat(e));t=o(a[1]),n=o(a[2]),r=o(a[3]),i=a[4]===void 0?255:o(a[4])}}else [t,n,r,i=255]=e;return new Float32Array([t/255,n/255,r/255,i/255])}const r=(e,t,n)=>{let r=e.createShader(n);if(e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){let t=`An error occurred compiling the shaders: ${e.getShaderInfoLog(r)}`;throw console.error(t),e.deleteShader(r),Error(t)}return r},i=(e,t)=>{let n=r(e,t.vertex,e.VERTEX_SHADER),i=r(e,t.fragment,e.FRAGMENT_SHADER),a=e.createProgram();if(n&&e.attachShader(a,n),i&&e.attachShader(a,i),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS)){let t=`Unable to initialize the shader program: ${e.getProgramInfoLog(a)}`;throw console.error(t),Error(t)}return a};var a=class{get id(){return this._id}get size(){return{x:this.width,y:this.height}}get isFreezed(){return this._freezed}get visible(){return this._visible}get position(){return this._position}get velocity(){return this._velocity}constructor(e){this.color=`#ffffff`,this._freezed=!1,this._visible=!0,this._velocity={x:0,y:0},this._id=Date.now().toString(),this._position=e.position,this._originalPosition=e.position,this.width=e.width,this.height=e.height,e?.color&&(this.color=e.color)}setPosition(e,t){this._position={x:e,y:t}}getColor(){return this.color}getParsedColor(){return n(this.color)}setColor(e){this.color=e}restoreOriginalPosition(){return this.setPosition(this._originalPosition.x,this._originalPosition.y),{...this._originalPosition}}setFreeze(e){this._freezed=e}setVisible(e){this._visible=e}},o=class{get motionParticles(){return this.drawLayer.particles}get gridData(){return{width:this.width,height:this.height}}get numCells(){return this.width*this.height}get size(){return this.width*this.cellSize}constructor(e={rows:32,columns:32,cellSize:20}){this.setGridOptions(e)}setGridOptions(e){this.width=e.rows,this.height=e.columns,this.cellSize=e.cellSize}setLayer(e){this.drawLayer=e}getLayer(){return this.drawLayer}setCellAtPosition(e,t,n){let{row:r,column:i}=this.getCellGridPosition(e,t);this.setCellInGrid(r,i,n)}setCellInGrid(e,t,n){if(this.getCellIndex(e,t)<0){this.addCell({row:e,column:t,color:n});return}this.updateCell(e,t,{color:n})}removeCellAtPosition(e,t){let{row:n,column:r}=this.getCellGridPosition(e,t);this.removeCell(n,r)}removeCell(e,t){let n=this.getCellIndex(e,t),r=this.drawLayer.particles.length-1,i=n;if(i>-1){if(this.drawLayer.lookup.delete(this.posKey(e,t)),n!==r){let e=this.drawLayer.particles[r];this.drawLayer.particles[i]=e,this.drawLayer.lookup.set(this.posKey(Math.floor(e.position.y/this.cellSize),Math.floor(e.position.x/this.cellSize)),i)}return this.drawLayer.particles.pop(),!0}return!1}addCell(e){let t=e.column*this.cellSize,n=e.row*this.cellSize,r=new a({position:{x:t,y:n},width:this.cellSize,height:this.cellSize,color:e.color});return this.drawLayer.particles.push(r),this.drawLayer.lookup.set(this.posKey(Math.floor(n/this.cellSize),Math.floor(t/this.cellSize)),this.drawLayer.particles.length-1),r}updateCell(e,t,n){let r=this.getCellIndex(e,t),i=this.drawLayer.particles[r];if(!i){console.error(`Cannot find cell at pos: row - col `,e,t);return}i.getColor()!==n.color&&i.setColor(n.color)}getCellIndex(e,t){let n=this.posKey(e,t);return this.drawLayer.lookup.get(n)??-1}getCellGridPosition(e,t){let n=Math.floor(t/this.cellSize),r=Math.floor(e/this.cellSize);return{row:n,column:r}}posKey(e,t){return`${e},${t}`}},s=class{constructor(){this.registry=new Map}apply(e,t=!0){t?this.register(e):this.unregister(e)}toggle(e){this.isRegistered(e)?this.unregister(e):this.register(e)}register(e){this.isRegistered(e)||this.registry.set(e.name,e)}isRegistered(e){return this.registry.get(e.name)!==void 0}unregister(e){return this.registry.delete(e.name)}},c=class e extends s{init(){this.loopTimer<=0&&this.reset()}update(e){this.loopTimer-=e}checkLoop(){return this.loopTimer>0?!1:(this.registry.forEach(e=>{this.loop(e)}),this.reset(),!0)}reset(){this.loopTimer=this.loopAfter}setLoopAfter(e){this.loopAfter=e}loop(e){e.particles.forEach(e=>{e.restoreOriginalPosition(),e.setFreeze(!1)})}constructor(){super(),this.loopAfter=2e3,this.loopTimer=0}static get instance(){return e._instance||=new e,e._instance}},l=class e extends s{init(){}update(e){}isColliding(e,t){return e.position.x<t.position.x+t.size.x&&e.position.x+e.size.x>t.position.x&&e.position.y<t.position.y+t.size.y&&e.position.y+e.size.y>t.position.y}isOutOfBounds(e,t){return e.position.x<0||e.position.x>=t.width||e.position.y<0||e.position.y>=t.height}constructor(){super()}static get instance(){return e._instance||=new e,e._instance}},u=class e extends s{init(){}update(e){}clear(){this._forces.clear()}upsertForce(e,t){this._forces.set(e,t)}removeForce(e){return this._forces.delete(e)}applyForces(e,t){let n={...t.position};return this._forces.forEach(e=>{let r=this.computeForce(t,e);n.x+=r.x,n.y+=r.y}),n}computeForce(e,t){return{x:e.size.x*t.x,y:e.size.y*t.y}}constructor(){super(),this._forces=new Map}static get instance(){return e._instance||=new e,e._instance}},d=class{constructor(){this.layers=[],this.lookup=new Map,this.active=``}create(e){this.layers.length===0&&this.setActive(e),this.layers.push({name:e,particles:[],lookup:new Map}),this.lookup.set(e,this.layers.length-1)}drop(e){let t=this.lookup.get(e)??-1;return t>=0?(this.layers.splice(t,1),this.lookup.delete(e),t):(console.error(`Cannot find layer: `,e),-1)}changeOrder(e,t){let n=this.layers.findIndex(t=>t.name===e);if(n===-1||t<0||t>=this.layers.length||n===t)return;let r=this.layers[n];if(n<t)for(let e=n;e<t;e++)this.layers[e]=this.layers[e+1];else for(let e=n;e>t;e--)this.layers[e]=this.layers[e-1];this.layers[t]=r}getByIndex(e){return this.layers[e]}getByName(e){let t=this.lookup.get(e)??-1;if(t>=0)return this.layers[t];console.error(`Cannot find layer: `,e)}getNames(){return this.layers.map(e=>e.name)}getAll(){return this.layers}clearAll(){this.getAll().forEach(e=>{e.lookup.clear(),e.particles=[]})}clear(e){let t=this.getByName(e);t?(t.lookup.clear(),t.particles=[]):console.error(`Cannot clear layer: `,e)}setActive(e){this.active=e}getActive(){return this.getByName(this.active)}getParticles(){return this.layers.reduce((e,t)=>(e=[...e,...t.particles],e),[])}};function f(){return{fragment:`#version 300 es
      precision mediump float;

      in vec4 v_color;
      out vec4 outColor;

      void main() {
        outColor = v_color;
      }`,vertex:`#version 300 es
      layout(location=0) in vec2 a_unit;
      layout(location=1) in vec2 a_offset;
      layout(location=2) in vec4 a_color;

      uniform mat4 u_projection;
      uniform float u_size;
      out vec4 v_color;

      void main() {
        vec2 pos = a_unit * u_size + a_offset;
        gl_Position = u_projection * vec4(pos, 0.0, 1.0);
        v_color = a_color;
      }`}}var p=class{get inited(){return this._inited}constructor(e,t){this.canvas=e,this.options=t,this.type=`webgl`,this._inited=!1,this.canExport=!1,this.backgroundColor=`#ffffff`,this.canExport=this.options.canExport,this.initWebGlContext();let{fragment:n,vertex:r}=f();this.renderPixelProgram=i(this.gl,{vertex:r,fragment:n}),this.createBuffers(),this.bindBuffers(),this._inited=!0}draw(e,t){let r=this.gl;r.viewport(0,0,this.canvas.width,this.canvas.height);let[i,a,o,s]=n(this.backgroundColor);r.clearColor(i,a,o,s),r.clear(r.COLOR_BUFFER_BIT);let c=new Float32Array(t.length*2),l=new Float32Array(t.length*16);for(let e=0;e<t.length;e++){let n=t[e];c[e*2]=n.position.x,c[e*2+1]=n.position.y;let r=n.getParsedColor();l[e*4]=r[0],l[e*4+1]=r[1],l[e*4+2]=r[2],l[e*4+3]=r[3]}r.bindBuffer(r.ARRAY_BUFFER,this.posVBO),r.bufferData(r.ARRAY_BUFFER,c,r.DYNAMIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,this.colVBO),r.bufferData(r.ARRAY_BUFFER,l,r.DYNAMIC_DRAW),r.useProgram(this.renderPixelProgram);let{cellSize:u,rows:d}=e;r.uniform1f(this.uCellSize,u);let f=u*d,p=this.getOrtographicMatrix(f);this.gl.uniformMatrix4fv(this.uProjectionMatrix,!1,p),r.bindVertexArray(this.vao),r.drawArraysInstanced(r.TRIANGLES,0,6,t.length),r.bindVertexArray(null)}resize(){e(this.gl.canvas),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}initWebGlContext(){this.gl=this.canvas.getContext(`webgl2`,{alpha:!0,preserveDrawingBuffer:this.canExport}),this.gl||console.error(`Cannot initialize webgl context`),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.resize()}getOrtographicMatrix(e){return t(0,e,e,0)}createBuffers(){this.renderPixelProgram&&(this.vao=this.gl.createVertexArray(),this.quadVBO=this.gl.createBuffer(),this.posVBO=this.gl.createBuffer(),this.colVBO=this.gl.createBuffer(),this.uCellSize=this.gl.getUniformLocation(this.renderPixelProgram,`u_size`),this.uProjectionMatrix=this.gl.getUniformLocation(this.renderPixelProgram,`u_projection`))}bindBuffers(){let e=this.gl;e.bindVertexArray(this.vao);let t=new Float32Array([0,0,1,0,0,1,1,0,1,1,0,1]);e.bindBuffer(e.ARRAY_BUFFER,this.quadVBO),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.posVBO),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,0,0),e.vertexAttribDivisor(1,1),e.bindBuffer(e.ARRAY_BUFFER,this.colVBO),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,4,e.FLOAT,!1,0,0),e.vertexAttribDivisor(2,1),e.bindVertexArray(null)}},m=class{get minFrameDuration(){return 1e3/this.maxFPS}get frameDuration(){return 1e3/this.targetFPS}get isRunning(){return this.running}constructor(e,t={canvas:{width:640,height:640},grid:{rows:32,columns:32},layers:{default:`layer-1`},init:!0,canExport:!0}){this.canvas=e,this.config=t,this.inited=!1,this.loopSystem=c.instance,this.forceSystem=u.instance,this.collisionSystem=l.instance,this.lastTime=0,this.accumulator=0,this.maxFPS=30,this.targetFPS=15,this.running=!1,this.defaultDrawColor=`#000000`,this.config.init&&this.init()}init(){if(this.inited){console.warn(`Paxel Renderer yet inited!`);return}if(this.setCanvas(),this.graphicsApi=new p(this.canvas,{canExport:this.config.canExport}),this.graphicsApi.inited){this.layersController=new d;let e=this.getGridOptions();this.gridController=new o(e);let t=this.config.layers?.default??`layer-1`;this.addLayer(t),this.config?.defaultColor&&(this.defaultDrawColor=this.config.defaultColor),this.inited=!0}}resize(){this.graphicsApi.resize(),this.inited&&this.draw()}setBackgroundColor(e){this.graphicsApi.backgroundColor=e}setCanvas(){let e=this.config.canvas.width,t=this.config.canvas.height;this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`;let n=window.devicePixelRatio||1,r=e,i=t;this.canvas.width=r*n,this.canvas.height=i*n}updateConfig(e){if(e.canvas!==void 0&&(this.config.canvas=e.canvas,this.setCanvas()),e.grid!==void 0){this.config.grid=e.grid;let t=this.getGridOptions();this.gridController.setGridOptions(t)}e.canExport!==void 0&&(this.config.canExport=e.canExport,this.graphicsApi.canExport=e.canExport)}drawAt(e,t,n){let r=n??this.defaultDrawColor;this.gridController.setCellAtPosition(e,t,r),this.draw()}removeAt(e,t){this.gridController.removeCellAtPosition(e,t),this.draw()}putPixel(e,t,n){let r=n??this.defaultDrawColor;this.gridController.setCellInGrid(e,t,r),this.draw()}removePixel(e,t){this.gridController.removeCell(e,t),this.draw()}createForce(e,t){this.forceSystem.upsertForce(e,t)}removeForce(e){this.forceSystem.removeForce(e)}applyForce(e,t=!0){let n=this.layersController.getByName(e);if(!n){console.error(`Cannot apply force to layer: `,e);return}this.forceSystem.apply(n,t)}setLoopTime(e){let t=e*1e3;this.loopSystem.setLoopAfter(t)}applyLoop(e,t=!0){let n=this.layersController.getByName(e);if(!n){console.error(`Cannot apply loop to layer: `,e);return}this.loopSystem.apply(n,t)}addLayer(e){let t=e??``;if(t||=`layer-${this.layersController.getAll().length+1}`,this.layersController.create(t),this.gridController.getLayer()===void 0){let e=this.layersController.getByIndex(0);this.gridController.setLayer(e)}}removeLayer(e){let t=this.layersController.drop(e);return t>=0&&this.draw(),t}getActiveLayer(){return this.gridController.getLayer()?.name}setActiveLayer(e){let t=this.layersController.getByName(e);t&&this.gridController.setLayer(t)}getLayers(){return this.layersController.getNames()}changeLayerOrder(e,t){this.layersController.changeOrder(e,t)}clearLayer(e){this.layersController.clear(e),this.draw()}clearAllLayers(){this.layersController.clearAll(),this.draw()}setFPS(e){if(e>this.maxFPS){console.warn(`The max fps limit is set to`,this.maxFPS);return}this.targetFPS=e}start(){this.isRunning||(this.running=!0,this.lastTime=performance.now(),this.loopSystem.init(),this.loop())}reset(){this.loopSystem.reset(),this.layersController.getParticles().forEach(e=>{e.restoreOriginalPosition(),e.setFreeze(!1)}),this.isRunning||this.draw()}stop(){this.isRunning&&(this.running=!1,this.loopFrameId&&=(cancelAnimationFrame(this.loopFrameId),null))}loop(e){if(!this.isRunning)return;let t=e??performance.now(),n=t-this.lastTime;if(this.lastTime=t,this.accumulator+=Math.min(n,200),this.accumulator>=this.frameDuration){let e=this.layersController.getAll();for(let t of e){if(!this.forceSystem.isRegistered(t))continue;let{particles:e}=t;if(this.loopSystem.update(this.accumulator),this.loopSystem.checkLoop())continue;for(let t of e){if(t.isFreezed)continue;let e=this.forceSystem.applyForces(n,t);t.setPosition(e.x,e.y)}}this.accumulator-=this.frameDuration}this.draw(),this.isRunning&&(this.loopFrameId=requestAnimationFrame(this.loop.bind(this)))}draw(){this.graphicsApi.draw(this.getGridOptions(),this.layersController.getParticles())}getCellSize(){return Math.floor(this.canvas.width/this.config.grid.rows)}getGridOptions(){return{rows:this.config.grid.rows,columns:this.config.grid.columns,cellSize:this.getCellSize()}}};export{m as PaxelRenderer};