function e(e){let t=e.clientWidth,n=e.clientHeight,r=e.width!==t||e.height!==n;return r&&(e.width=t,e.height=n),r}function t(e,t,n,r,i=-1,a=1){let o=1/(e-t),s=1/(n-r),c=1/(i-a);return new Float32Array([-2*o,0,0,0,0,-2*s,0,0,0,0,2*c,0,(e+t)*o,(r+n)*s,(a+i)*c,1])}function n(e){let t,n,r,i;if(typeof e==`string`){e=e.trim();let a=e.match(/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/);if(a){let e=a[1];t=parseInt(e.slice(0,2),16),n=parseInt(e.slice(2,4),16),r=parseInt(e.slice(4,6),16),i=e.length===8?parseInt(e.slice(6,8),16):255}else{let a=e.match(/^rgba?\(\s*([\d.]+%?)\s*,\s*([\d.]+%?)\s*,\s*([\d.]+%?)\s*(?:,\s*([\d.]+%?)\s*)?\)$/);if(!a)return console.error(`Color format not valid: "${e}"`),new Float32Array([1,1,1,1]);let o=e=>e.endsWith(`%`)?Math.round(parseFloat(e)/100*255):Math.round(parseFloat(e));t=o(a[1]),n=o(a[2]),r=o(a[3]),i=a[4]===void 0?255:o(a[4])}}else [t,n,r,i=255]=e;return new Float32Array([t/255,n/255,r/255,i/255])}const r=(e,t,n)=>{let r=e.createShader(n);if(e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){let t=`An error occurred compiling the shaders: ${e.getShaderInfoLog(r)}`;throw console.error(t),e.deleteShader(r),Error(t)}return r},i=(e,t)=>{let n=r(e,t.vertex,e.VERTEX_SHADER),i=r(e,t.fragment,e.FRAGMENT_SHADER),a=e.createProgram();if(n&&e.attachShader(a,n),i&&e.attachShader(a,i),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS)){let t=`Unable to initialize the shader program: ${e.getProgramInfoLog(a)}`;throw console.error(t),Error(t)}return a};var a=class{get id(){return this._id}get size(){return{x:this.width,y:this.height}}get isFreezed(){return this._freezed}get visible(){return this._visible}get position(){return this._position}get velocity(){return this._velocity}constructor(e){this.color=`#ffffff`,this._freezed=!1,this._visible=!0,this._velocity={x:0,y:0},this._id=this.getUuid(),this._position=e.position,this._originalPosition=e.position,this.width=e.width,this.height=e.height,e?.color&&(this.color=e.color)}setPosition(e,t){this._position={x:e,y:t}}getColor(){return this.color}getParsedColor(){return n(this.color)}setColor(e){this.color=e}restoreOriginalPosition(){return this.setPosition(this._originalPosition.x,this._originalPosition.y),{...this._originalPosition}}setFreeze(e){this._freezed=e}setVisible(e){this._visible=e}getUuid(){return`${Date.now().toString(36)+Math.random().toString(36).slice(2,7)}`}},o=class{get motionParticles(){return this.drawLayer.particles}get gridData(){return{width:this.width,height:this.height}}get numCells(){return this.width*this.height}get size(){return this.width*this.cellSize}constructor(e={rows:32,columns:32,cellSize:20}){this.setGridOptions(e)}setGridOptions(e){this.width=e.rows,this.height=e.columns,this.cellSize=e.cellSize}setLayer(e){this.drawLayer=e}getLayer(){return this.drawLayer}setCellAtPosition(e,t,n){let{row:r,column:i}=this.getCellGridPosition(e,t);this.setCellInGrid(r,i,n)}setCellInGrid(e,t,n){if(this.getCellIndex(e,t)<0){this.addCell({row:e,column:t,color:n});return}this.updateCell(e,t,{color:n})}removeCellAtPosition(e,t){let{row:n,column:r}=this.getCellGridPosition(e,t);this.removeCell(n,r)}removeCell(e,t){let n=this.getCellIndex(e,t),r=this.drawLayer.particles.length-1,i=n;if(i>-1){if(this.drawLayer.lookup.delete(this.posKey(e,t)),n!==r){let e=this.drawLayer.particles[r];this.drawLayer.particles[i]=e,this.drawLayer.lookup.set(this.posKey(Math.floor(e.position.y/this.cellSize),Math.floor(e.position.x/this.cellSize)),i)}return this.drawLayer.particles.pop(),!0}return!1}addCell(e){let t=e.column*this.cellSize,n=e.row*this.cellSize,r=new a({position:{x:t,y:n},width:this.cellSize,height:this.cellSize,color:e.color});return this.drawLayer.particles.push(r),this.drawLayer.lookup.set(this.posKey(Math.floor(n/this.cellSize),Math.floor(t/this.cellSize)),this.drawLayer.particles.length-1),r}updateCell(e,t,n){let r=this.getCellIndex(e,t),i=this.drawLayer.particles[r];if(!i){console.error(`Cannot find cell at pos: row - col `,e,t);return}i.getColor()!==n.color&&i.setColor(n.color)}getCellIndex(e,t){let n=this.posKey(e,t);return this.drawLayer.lookup.get(n)??-1}getCellGridPosition(e,t){let n=Math.floor(t/this.cellSize),r=Math.floor(e/this.cellSize);return{row:n,column:r}}posKey(e,t){return`${e},${t}`}},s=class{constructor(){this.registry=new Map}apply(e,t=!0){t?this.register(e):this.unregister(e)}toggle(e){this.isRegistered(e)?this.unregister(e):this.register(e)}register(e){this.isRegistered(e)||this.registry.set(e.name,e)}isRegistered(e){return this.registry.get(e.name)!==void 0}unregister(e){return this.registry.delete(e.name)}},c=class e extends s{init(){this.loopTimer<=0&&this.reset()}update(e){this.loopTimer-=e}checkLoop(){return this.loopTimer>0?!1:(this.registry.forEach(e=>{this.loop(e)}),this.reset(),!0)}reset(){this.loopTimer=this.loopAfter}setLoopAfter(e){this.loopAfter=e}loop(e){e.particles.forEach(e=>{e.restoreOriginalPosition(),e.setFreeze(!1),e.setVisible(!0)})}constructor(){super(),this.loopAfter=2e3,this.loopTimer=0}static get instance(){return e._instance||(e._instance=new e),e._instance}},l=class e extends s{init(){}update(e){}getLayerCollisionOptions(e){return this.collisionLayers.get(e)}getLayerColliders(e){return this.collisionLayers.get(e)?.colliders||[]}setLayerCollisionOptions(e,t){let n=this.collisionLayers.get(e);n?this.collisionLayers.set(e,{...n,...t}):this.collisionLayers.set(e,t)}isColliding(e,t){return e.position.x<t.position.x+t.size.x&&e.position.x+e.size.x>t.position.x&&e.position.y<t.position.y+t.size.y&&e.position.y+e.size.y>t.position.y}isOutOfBounds(e,t){let n=e.position.x<0,r=e.position.x>=t.width,i=e.position.y<0,a=e.position.y>=t.height;return{out:n||r||i||a,outLeft:n,outBottom:a,outRight:r,outTop:i}}checkParticleCollision(e,t,n,r){let i=this.getLayerCollisionOptions(e);return this.isColliding({position:n,size:t.size},{position:r.position,size:r.size})&&i?(this.resolveCollisionResponse(t,i),!0):!1}resolveCollisionResponse(e,t){t?.destroyOnCollision?this.resolveCollisionByType(e,`destroy`):t?.loopOnCollision?this.resolveCollisionByType(e,`loop`):this.resolveCollisionByType(e,`freeze`)}resolveCollisionByType(e,t){switch(t){case`destroy`:e.setVisible(!1),e.setFreeze(!0);break;case`loop`:e.restoreOriginalPosition();break;case`freeze`:e.setFreeze(!0);break;default:break}}checkBoundsCollision(e,t,n,r){let i=this.getLayerCollisionOptions(t),{outLeft:a,outRight:o,outBottom:s,outTop:c,out:l}=this.isOutOfBounds({position:r,size:n.size},e);if(l){if(i?.destroyOnCollision)n.setVisible(!1),n.setFreeze(!0);else if(i?.loopOnCollision)n.restoreOriginalPosition();else if(i?.stopOnBounds){let t=this.getCanvasMeasures(e);s?n.setPosition(r.x,t.bottom-n.size.x):c?n.setPosition(r.x,t.top):a?n.setPosition(t.left,r.y):o&&n.setPosition(t.right-n.size.x,r.y),n.setFreeze(!0)}return!0}return!1}getCanvasMeasures(e){return{top:0,left:0,right:e.width,bottom:e.height}}constructor(){super(),this.collisionLayers=new Map}static get instance(){return e._instance||(e._instance=new e),e._instance}},u=class e extends s{init(){}update(e){}clear(){this.forces=[]}addForceToLayer(e,t){let n=this.getForceByName(t);if(n){let t=this.getForcesOnLayer(e);this.forcesOnLayers.set(e,Array.from(new Set([...t,n])))}}removeForceFromLayer(e,t){let n=this.getForcesOnLayer(e),r=n.findIndex(e=>e.name===t);r>=0&&(n.splice(r,1),this.forcesOnLayers.set(e,n))}getForcesOnLayer(e){return this.forcesOnLayers.get(e)||[]}getLayerForcesResult(e){let t=this.getForcesOnLayer(e),n={x:0,y:0};return t?.reduce((e,t)=>(e.x+=t.intensity.x,e.y+=t.intensity.y,e),n)??n}getForceByName(e){let t=this.forces.find(t=>t.name===e);return t||console.warn(`Cannot find force with name:`,t),t}upsertForce(e,t){this.forces.push({name:e,intensity:t})}removeForce(e){let t=this.forces.findIndex(t=>t.name===e);return t>=0?(this.forces.splice(t,1),t):-1}applyForceToParticle(e,t){let n=this.computeForce(t,e);return{x:t.position.x+n.x,y:t.position.y+n.y}}computeForce(e,t){return{x:e.size.x*t.x,y:e.size.y*t.y}}constructor(){super(),this.forces=[],this.forcesOnLayers=new Map}static get instance(){return e._instance||(e._instance=new e),e._instance}},d=class{constructor(e){this.particles=[],this.lookup=new Map,this.visible=!0,this._id=this.getUuid(),this.name=e.name,this.visible=e.visible,this.particles=e.particles}getUuid(){return`${Date.now().toString(36)+Math.random().toString(36).slice(2,7)}`}},f=class{constructor(){this.layers=[],this.lookup=new Map,this.active=``}list(){return this.layers.map(e=>e.name)}getAll(){return this.layers}create(e){this.layers.length===0&&this.setActive(e);let t=new d({name:e,particles:[],visible:!0});return this.layers.push(t),this.lookup.set(e,this.layers.length-1),t}drop(e){let t=this.lookup.get(e)??-1;return t>=0?(this.layers.splice(t,1),this.updateIndexesLookup(t),this.lookup.delete(e),t):(console.error(`Cannot find layer: `,e),-1)}updateIndexesLookup(e){this.lookup.forEach((t,n)=>{t>e&&this.lookup.set(n,--t)})}changeOrder(e,t){let n=this.layers.findIndex(t=>t.name===e);if(n===-1||t<0||t>=this.layers.length||n===t)return;let r=this.layers[n];if(n<t)for(let e=n;e<t;e++)this.layers[e]=this.layers[e+1];else for(let e=n;e>t;e--)this.layers[e]=this.layers[e-1];this.layers[t]=r}getByIndex(e){return this.layers[e]}getById(e){let t=this.layers.findIndex(t=>t._id===e);if(t>=0)return this.layers[t]}getByName(e){let t=this.lookup.get(e)??-1;if(t>=0)return this.layers[t];console.warn(`Cannot find layer: `,e)}clearAll(){this.layers.forEach(e=>{e.lookup.clear(),e.particles=[]})}clear(e){let t=this.getByName(e);t?(t.lookup.clear(),t.particles=[]):console.error(`Cannot clear layer: `,e)}setActive(e){this.active=e}setVisible(e,t){let n=this.getByName(e);n&&(n.visible=t)}getActive(){return this.getByName(this.active)}getParticles(e){return this.layers.reduce((t,n)=>{let r=n.name,i=!this.isVisible(n),a=!0,o=!1;return e?.excludeLayers&&(o=!!e.excludeLayers.includes(r)),e?.includeLayers&&(a=!!e.includeLayers.includes(r)),i||!a||o||(t=[...t,...n.particles.filter(e=>e.visible)]),t},[])}isVisible(e){return e.visible}};function p(){return{fragment:`#version 300 es
      precision mediump float;

      in vec4 v_color;
      out vec4 outColor;

      void main() {
        outColor = v_color;
      }`,vertex:`#version 300 es
      layout(location=0) in vec2 a_unit;
      layout(location=1) in vec2 a_offset;
      layout(location=2) in vec4 a_color;

      uniform mat4 u_projection;
      uniform float u_size;
      out vec4 v_color;

      void main() {
        vec2 pos = a_unit * u_size + a_offset;
        gl_Position = u_projection * vec4(pos, 0.0, 1.0);
        v_color = a_color;
      }`}}var m=class{get inited(){return this._inited}constructor(e,t){this.canvas=e,this.options=t,this.type=`webgl`,this._inited=!1,this.canExport=!1,this.backgroundColor=``,this.canExport=this.options.canExport,this.initWebGlContext();let{fragment:n,vertex:r}=p();this.renderPixelProgram=i(this.gl,{vertex:r,fragment:n}),this.createBuffers(),this.bindBuffers(),this._inited=!0}draw(e,t){let r=this.gl;if(r.viewport(0,0,this.canvas.width,this.canvas.height),this.backgroundColor){let[e,t,i,a]=n(this.backgroundColor);r.clearColor(e,t,i,a)}r.clear(r.COLOR_BUFFER_BIT);let i=new Float32Array(t.length*2),a=new Float32Array(t.length*16);for(let e=0;e<t.length;e++){let n=t[e];i[e*2]=n.position.x,i[e*2+1]=n.position.y;let r=n.getParsedColor();a[e*4]=r[0],a[e*4+1]=r[1],a[e*4+2]=r[2],a[e*4+3]=r[3]}r.bindBuffer(r.ARRAY_BUFFER,this.posVBO),r.bufferData(r.ARRAY_BUFFER,i,r.DYNAMIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,this.colVBO),r.bufferData(r.ARRAY_BUFFER,a,r.DYNAMIC_DRAW),r.useProgram(this.renderPixelProgram);let{cellSize:o,rows:s}=e;r.uniform1f(this.uCellSize,o);let c=o*s,l=this.getOrtographicMatrix(c);this.gl.uniformMatrix4fv(this.uProjectionMatrix,!1,l),r.bindVertexArray(this.vao),r.drawArraysInstanced(r.TRIANGLES,0,6,t.length),r.bindVertexArray(null)}resize(){e(this.gl.canvas),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}initWebGlContext(){this.gl=this.canvas.getContext(`webgl2`,{alpha:!0,preserveDrawingBuffer:this.canExport}),this.gl||console.error(`Cannot initialize webgl context`),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.resize()}getOrtographicMatrix(e){return t(0,e,e,0)}createBuffers(){this.renderPixelProgram&&(this.vao=this.gl.createVertexArray(),this.quadVBO=this.gl.createBuffer(),this.posVBO=this.gl.createBuffer(),this.colVBO=this.gl.createBuffer(),this.uCellSize=this.gl.getUniformLocation(this.renderPixelProgram,`u_size`),this.uProjectionMatrix=this.gl.getUniformLocation(this.renderPixelProgram,`u_projection`))}bindBuffers(){let e=this.gl;e.bindVertexArray(this.vao);let t=new Float32Array([0,0,1,0,0,1,1,0,1,1,0,1]);e.bindBuffer(e.ARRAY_BUFFER,this.quadVBO),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.posVBO),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,0,0),e.vertexAttribDivisor(1,1),e.bindBuffer(e.ARRAY_BUFFER,this.colVBO),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,4,e.FLOAT,!1,0,0),e.vertexAttribDivisor(2,1),e.bindVertexArray(null)}},h=class{get minFrameDuration(){return 1e3/this.maxFPS}get frameDuration(){return 1e3/this.targetFPS}get isRunning(){return this.running}constructor(e,t={canvas:{width:640,height:640},grid:{rows:32,columns:32},defaultLayer:`layer-1`,init:!0,canExport:!0}){this.canvas=e,this.config=t,this.inited=!1,this.loopSystem=c.instance,this.forceSystem=u.instance,this.collisionSystem=l.instance,this.lastTime=0,this.accumulator=0,this.maxFPS=30,this.targetFPS=15,this.running=!1,this.defaultDrawColor=`#000000`,this.config.init&&this.init()}init(){if(this.inited){console.warn(`Paxel Renderer yet inited!`);return}if(this.setCanvas(),this.graphicsApi=new m(this.canvas,{canExport:this.config.canExport}),this.graphicsApi.inited){this.layersController=new f;let e=this.getGridOptions();this.gridController=new o(e);let t=this.config.defaultLayer;this.addLayer(t),this.config?.defaultColor&&(this.defaultDrawColor=this.config.defaultColor),this.inited=!0}}resize(){this.graphicsApi.resize(),this.inited&&this.draw()}setBackgroundColor(e){this.graphicsApi.backgroundColor=e,this.draw()}setCanvas(){let e=this.config.canvas.width,t=this.config.canvas.height;this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`;let n=window.devicePixelRatio||1,r=e,i=t;this.canvas.width=r*n,this.canvas.height=i*n}updateConfig(e){if(e.canvas!==void 0&&(this.config.canvas=e.canvas,this.setCanvas()),e.grid!==void 0){this.config.grid=e.grid;let t=this.getGridOptions();this.gridController.setGridOptions(t)}e.canExport!==void 0&&(this.config.canExport=e.canExport,this.graphicsApi.canExport=e.canExport)}drawAt(e,t,n,r){r&&this.setActiveLayer(r);let i=n??this.defaultDrawColor;this.gridController.setCellAtPosition(e,t,i),this.draw()}removeAt(e,t,n){n&&this.setActiveLayer(n),this.gridController.removeCellAtPosition(e,t),this.draw()}putPixel(e,t,n,r){r&&this.setActiveLayer(r);let i=n??this.defaultDrawColor;this.gridController.setCellInGrid(e,t,i),this.draw()}removePixel(e,t,n){n&&this.setActiveLayer(n),this.gridController.removeCell(e,t),this.draw()}createForce(e,t){this.forceSystem.upsertForce(e,t)}removeForce(e){this.forceSystem.removeForce(e)}applyForce(e,t=!0){let n=this.layersController.getByName(e);if(!n){console.error(`Cannot apply force to layer: `,e);return}this.forceSystem.apply(n,t)}setForceOnLayer(e,t){let n=this.layersController.getByName(e);n&&this.forceSystem.addForceToLayer(n,t)}removeForceFromLayer(e,t){let n=this.layersController.getByName(e);n&&this.forceSystem.removeForceFromLayer(n,t)}setLoopDuration(e){let t=e*1e3;this.loopSystem.setLoopAfter(t)}applyLoop(e,t=!0){let n=this.layersController.getByName(e);if(!n){console.error(`Cannot apply loop to layer: `,e);return}this.loopSystem.apply(n,t)}applyCollision(e,t=!0){let n=this.layersController.getByName(e);if(!n){console.error(`Cannot apply loop to layer: `,e);return}this.collisionSystem.apply(n,t)}addLayer(e,t={force:!0,loop:!0,collision:!0}){if(!e){console.warn(`Cannot add layer with invalid name: `,e);return}if(this.layersController.getByName(e)){console.warn(`Cannot add layer with name of existing layer: `,e);return}let n=this.layersController.create(e);if(this.gridController.getLayer()===void 0){let e=this.layersController.getByIndex(0);this.gridController.setLayer(e)}let{force:r,loop:i,collision:a}=t;return r!==void 0&&this.applyForce(n.name,r),i!==void 0&&this.applyLoop(n.name,i),a!==void 0&&this.applyCollision(n.name,a),e}removeLayerByName(e){let t=this.layersController.drop(e);return t>=0&&this.draw(),t}getActiveLayer(){return this.gridController.getLayer().name}setActiveLayer(e){let t=this.layersController.getByName(e);t&&this.gridController.setLayer(t)}setLayerVisibility(e,t){this.layersController.setVisible(e,t),this.draw()}setLayerCollision(e,t){let n=this.layersController.getByName(e);n&&this.collisionSystem.setLayerCollisionOptions(n,t)}getLayers(){return this.layersController.list()}changeLayerOrder(e,t){this.layersController.changeOrder(e,t)}clearLayer(e){this.layersController.clear(e),this.draw()}clearAllLayers(){this.layersController.clearAll(),this.draw()}setFPS(e){if(e>this.maxFPS){console.warn(`The max fps limit is set to`,this.maxFPS);return}this.targetFPS=e}start(){this.isRunning||(this.running=!0,this.lastTime=performance.now(),this.loopSystem.init(),this.loop())}reset(){this.loopSystem.reset(),this.layersController.getParticles().forEach(e=>{e.restoreOriginalPosition(),e.setFreeze(!1)}),this.isRunning||this.draw()}stop(){this.isRunning&&(this.running=!1,this.loopFrameId&&(cancelAnimationFrame(this.loopFrameId),this.loopFrameId=null))}loop(e){if(!this.isRunning)return;let t=e??performance.now(),n=t-this.lastTime;if(this.lastTime=t,this.accumulator+=Math.min(n,200),this.accumulator>=this.frameDuration){let e=this.layersController.getAll();this.loopSystem.update(this.accumulator);for(let t of e){if(!t.visible)continue;let{particles:e}=t,n=this.forceSystem.isRegistered(t),r=this.collisionSystem.isRegistered(t);for(let i of e){if(i.isFreezed)continue;let e={...i.position};if(n){let n=this.forceSystem.getLayerForcesResult(t);e=this.forceSystem.applyForceToParticle(n,i)}if(r){let n=this.collisionSystem.getLayerCollisionOptions(t);if(n?.stopOnBounds&&this.collisionSystem.checkBoundsCollision(this.canvas,t,i,e)){this.collisionSystem.resolveCollisionResponse(i,n);continue}let r=!1,a=this.collisionSystem.getLayerColliders(t),o=this.layersController.getParticles({includeLayers:a});for(let n of o){if(i.id===n.id)continue;if(r=this.collisionSystem.checkParticleCollision(t,i,e,n),r)break}if(r)continue}i.setPosition(e.x,e.y)}}this.loopSystem.checkLoop(),this.accumulator=0}this.draw(),this.isRunning&&(this.loopFrameId=requestAnimationFrame(this.loop.bind(this)))}draw(){this.graphicsApi.draw(this.getGridOptions(),this.layersController.getParticles())}getCellSize(){return Math.floor(this.canvas.width/this.config.grid.rows)}getGridOptions(){return{rows:this.config.grid.rows,columns:this.config.grid.columns,cellSize:this.getCellSize()}}};export{h as PaxelRenderer};